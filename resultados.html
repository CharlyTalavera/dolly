<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1" />
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Last-Modified" content="0">
  <meta http-equiv="Cache-Control" content="no-cache, mustrevalidate">
  <meta http-equiv="Pragma" content="no-cache">

  <title>Encuestas de Cursos</title>

  <link rel="stylesheet" href="./css/bootstrap.min.css"./>
  <link rel="stylesheet" href="./css/grid-radio.css"./>
  <script src="./js/jquery-3.3.1.min.js"></script>
  <script src="./js/jquery.scrollTo.min.js"></script>
  <script src="./js/jquery.getUrlParam.js"></script>

  <script src="./js/popper.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <!-- bootstrap-select -->
  <link rel="stylesheet" href="./css/bootstrap-select.min.css">
  <script src="./js/bootstrap-select.min.js"></script>
  <script src="./js/i18n/defaults-es_ES.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="./css/all.css"./>

  <!-- custom -->
  <link rel="stylesheet" href="./css/custom.css"./>

  <!-- Scripts -->
  <script src="./js/config.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/form_mannager.js"></script>
  <script src="./js/questions.js"></script>
  <script src="./js/pool.js"></script>
  <script src="./js/change_docentes.js"></script>

  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="./manifest.json">
  <meta name="mobile-web-app-capable" content="yes">

</head>
<body>
  <nav class="navbar sticky-top navbar-expand-sm navbar-light bg-light justify-content-between">
    <div class="navbar-brand" href="./index.html">
      <img style="width: 64px; height: 64px"  src="./img/DOLLY_imagen.png" width="100">
      <span class="d-inline-block align-top">
        <img style="height: 45px" src="./img/DOLLY_LOGO.png" ></img>
        <small><p class="pb-0 mb-0">Sistema Automatizado de Encuestas Fiubenses</p></small>
      </span>
    </div>


    <!-- options menu -->
    <!--<button type="button" class="btn btn-outline-default btn-circle"><img class="img-circle" src="files/img/note.png"./></button>-->
    <div class="navbar-nav dropdown">
      <a href="index.html" type="button" class="btn btn-warning mr-1"><i class="fas fa-chart-bar"></i> Cargar encuesta</a>
     <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Opciones
      </button>
      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#modal-dolly-programa">Acerca de Dolly</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- modal -->
   <div class="modal" tabindex="-1" role="dialog" id="modal-dolly-programa">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body" align="center"  >
            <img src="./img/ovejas_simpsons.gif" align="center" >
            <p>MÃ¡s <strike>deliciosa</strike> tierna info en el <a href="https://github.com/lugfi/dolly">repo</a>.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Owww</button>
          </div>
        </div>
      </div>
    </div>
      <table class="table table-condensed" style="border-collapse:collapse;">
      <thead>
        <tr>
          <th>Score</th>
          <th>Docente</th>
          <th>Resultados</th>
          <th>#Resp (Coment)</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td>Cargando...</td></tr>
      </tbody>
  </table>
  </div>

<script>
  Results = {};

  // Load data JSON
  $.getJSON("analitics/valoraciones_docentes.json", function(data,st){
    // Prepare keys
    Results.materias = get_indexes('mat',data);
    Results.docentes = get_indexes('doc',data);
    Results.data = data;
    console.log("data loaded");
    Table.init();
    Table.filterMateria($(document).getUrlParam("mat"));
  }).fail(function(err){
    console.log("error loading data");
    throw err;
  });

  function get_indexes(index_name, data){
    let conj = {};
    data.forEach(function(x){
      conj[x[index_name]] = true;
    });
    return Object.keys(conj);
  }

  Calc = {
    score(data){
      let tot = 0;
      Object.keys(Calc.pesos).forEach(function(k){
        tot += data[k]*Calc.pesos[k];
      });
      return tot/Calc.sum(Calc.pesos);
    },
    pesos: {
      'asistencia': 1,
      'cumple_horarios': 1,
      'clase_organizada': .7,
      'claridad': .7,
      'buen_trato': 0.5,
      'acepta_critica': 0.5,
      'fomenta_participacion': 0.5,
      'responde_mails': 0.5,
      'panorama_amplio': 0.5
    },
    roundScore: function(x){
      return Math.round(10*x)/10;
    },
    sum: function(arr){
      return Object.values(arr).reduce((a,b)=>a+b)
    },
    mean: function(arr){
      return Object.values(arr).reduce((a,b)=>a+b)/Object.values(arr).length;
    },
  }

  Table = {
    lastrow:0,
    init: function(){
      Table.clearTable();
    },
    filterMateria(mat){
      const rows = Results.data.filter(row => (row.mat == mat))
      Table.loadTable(rows);
    },
    loadTable(rows){
      // Calculate Score
      rows.map(function(row){
        row.score = Calc.score(row);
        return row;
      });

      const sorted_rows = rows.sort((a,b) => (b.score-a.score));

      sorted_rows.forEach(function(row){

        Table.addRow([
          {text: Calc.roundScore(row.score), class:"bg-warning"},
          {text: row.doc, class:"bg-info"},
          {text: "resultados", class:"bg-success"},
          {text: "cantidad", class:"bg-primary"},
        ],["a","b",334]);
      });
    },
    clearTable(){
      $("#tbody").empty();
      Table.lastrow = 0;
    },
    addRow(row, comments){
      // row = [{text:"", class:""}...{}]
      // comments = []
      const id = Table.lastrow++;

      // Create comments html
      let comments_items = "";
      comments && comments.forEach(function(comment){
        comments_items += Table.comment_html.replace("COMMENT", comment);
      });

      // Create row html
      let row_html = "";
      row.forEach(function(elem){
        row_html += Table.row_html.replace("TEXT", elem.text || "").replace("CLASS", elem.class || "");
      });

      const raw_html = Table.html_item + (comments? Table.comment_div : "");
      const html = raw_html.replace(/ID/g, id).replace("DATA_ROW",row_html).replace("COMMENT_LIST", comments_items || "");

      $("#tbody").append(html);
    },
    html_item: '<tr data-toggle="collapse" data-target="#demoID" class="accordion-toggle">\
      DATA_ROW\
    </tr>',
    comment_div:'<tr>\
        <td colspan="6" class="hiddenRow">\
            <div id="demoID" class="accordian-body collapse ml-3">\
            COMMENT_LIST\
            </div>\
        </td>\
    </tr>',
    row_html: '<td class="CLASS">TEXT</td>',
    comment_html: '<div class="col-12 zebra">COMMENT</div>'
  }
</script>

</body>
</html>
