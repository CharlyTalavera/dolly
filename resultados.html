<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1" />
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Last-Modified" content="0">
  <meta http-equiv="Cache-Control" content="no-cache, mustrevalidate">
  <meta http-equiv="Pragma" content="no-cache">

  <title>Encuestas de Cursos</title>

  <link rel="stylesheet" href="./css/bootstrap.min.css"./>
  <link rel="stylesheet" href="./css/grid-radio.css"./>
  <script src="./js/jquery-3.3.1.min.js"></script>
  <script src="./js/jquery.scrollTo.min.js"></script>
  <script src="./js/jquery.getUrlParam.js"></script>

  <script src="./js/popper.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <!-- bootstrap-select -->
  <link rel="stylesheet" href="./css/bootstrap-select.min.css">
  <script src="./js/bootstrap-select.min.js"></script>
  <script src="./js/i18n/defaults-es_ES.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="./css/all.css"./>

  <!-- custom -->
  <link rel="stylesheet" href="./css/custom.css"./>

  <!-- Scripts -->
  <script src="./js/config.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/form_mannager.js"></script>
  <script src="./js/questions.js"></script>
  <script src="./js/pool.js"></script>
  <script src="./js/change_docentes.js"></script>

  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="./manifest.json">
  <meta name="mobile-web-app-capable" content="yes">

</head>
<body>
  <nav class="navbar sticky-top navbar-expand-sm navbar-light bg-light justify-content-between">
    <div class="navbar-brand" href="./index.html">
      <img style="width: 64px; height: 64px"  src="./img/DOLLY_imagen.png" width="100">
      <span class="d-inline-block align-top">
        <img style="height: 45px" src="./img/DOLLY_LOGO.png" ></img>
        <small><p class="pb-0 mb-0">Sistema Automatizado de Encuestas Fiubenses</p></small>
      </span>
    </div>


    <!-- options menu -->
    <!--<button type="button" class="btn btn-outline-default btn-circle"><img class="img-circle" src="files/img/note.png"./></button>-->
    <div class="navbar-nav dropdown">
      <a href="index.html" type="button" class="btn btn-warning mr-1"><i class="fas fa-chart-bar"></i> Cargar encuesta</a>
     <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Opciones
      </button>
      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#modal-dolly-programa">Acerca de Dolly</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- modal -->
   <div class="modal" tabindex="-1" role="dialog" id="modal-dolly-programa">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body" align="center"  >
            <img src="./img/ovejas_simpsons.gif" align="center" >
            <p>Más <strike>deliciosa</strike> tierna info en el <a href="https://github.com/lugfi/dolly">repo</a>.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Owww</button>
          </div>
        </div>
      </div>
    </div>

    <div>
      <label for="materia" class="col-sm-2 col-form-label">Materia</label>
      <select id="materia" class="col-sm-10 selectpicker show-tick " data-container="body" data-live-search="true" data-style="btn-primary" title="Elegí la materia" disabled> </select>
    </div>

      <table class="table table-condensed" style="border-collapse:collapse;">
      <thead>
        <tr>
          <th>Score</th>
          <th>#Resp</th>
          <th>Docente</th>
          <th>Resultados</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td>Contando ovejas...</td></tr>
      </tbody>
  </table>
  </div>

<script>
  Results = {};

  // Load data JSON
  getJSON("analitics/valoraciones_docentes.json", function(data,st){
    // Prepare keys
    Results.materias = get_indexes('mat',data);
    Results.docentes = get_indexes('doc',data);
    Results.data = data;
    console.log("data loaded");
    // Load comments
    getJSON("analitics/comentarios_docentes.json", function(data,st){
      // Decode
      Results.comentarios = data.map(function(x){
        x.comentarios = x.comentarios.map(b64_to_utf8);
        return x;
      });
      console.log("comments loaded");

      Table.init();
      Table.filterMateria($(document).getUrlParam("mat"));
    }).fail(function(err){
      console.log("error loading comments");
    });
  }).fail(function(err){
    console.log("error loading data");
  });

  function get_indexes(index_name, data){
    let conj = {};
    data.forEach(function(x){
      conj[x[index_name]] = true;
    });
    return Object.keys(conj);
  }

  Calc = {
    detalle(data){
      const res = Object.keys(Calc.pesos).map(k => data[k]);
      colors = res.map(x => Calc.colors[Math.floor(Math.abs(x-0.001))]);

      const number_html = "<span class='m-0 p-1' style='background-color: COLOR'>NUMBER</span>";
      let html="";
      res.forEach(function(n,i){
        html += number_html.replace("COLOR", colors[i]).replace("NUMBER", Calc.roundScoreFix(n));
      });
      return html;
    },
    score(data){
      let tot = 0;
      Object.keys(Calc.pesos).forEach(function(k){
        tot += data[k]*Calc.pesos[k];
      });
      return tot/Calc.sum(Calc.pesos);
    },
    colors:[
      '#ff0000', //:(
      '#ff8000',
      '#ffff33', //:|
      '#b2ff66',
      '#33ff33'  //:D
    ],
    pesos: {
      'asistencia': 1,
      'cumple_horarios': 1,
      'clase_organizada': .7,
      'claridad': .7,
      'buen_trato': 0.5,
      'acepta_critica': 0.5,
      'fomenta_participacion': 0.5,
      'responde_mails': 0.5,
      'panorama_amplio': 0.5
    },
    roundScore: function(x){
      return Math.round(10*x)/10;
    },
    roundScoreFix: function(x){
      let str = "" + (Math.round(10*x)/10);
      str += (str.length==1)?".0":"";
      return str;
    },
    sum: function(arr){
      return Object.values(arr).reduce((a,b)=>a+b)
    },
    mean: function(arr){
      return Object.values(arr).reduce((a,b)=>a+b)/Object.values(arr).length;
    },
  }

  Table = {
    lastrow:0,
    init: function(){
      Table.clearTable();
    },
    filterMateria(mat){
      const rows = Results.data.filter(row => (row.mat == mat));
      const comments = Results.comentarios.filter(x => (x.mat == mat));
      Table.loadTable(rows, comments);
    },
    loadTable(rows, comments){
      // Calculate Score
      rows.map(function(row){
        row.score = Calc.score(row);
        return row;
      });

      // Sort table by score
      const sorted_rows = rows.sort((a,b) => (b.score-a.score));

      // Populate table
      sorted_rows.forEach(function(row){
        const comm = comments.filter(x => x.doc==row.doc);
        const comms = comm && comm[0].comentarios;

        const txt_resp = ""+row.respuestas+" <i class='fas fa-users'></i>" + (comms?"<span class='ml-1'>"+comms.length+" <i class='fas fa-comment-dots'></i></span>":"");
        const class_colors = (row.respuestas<5)?((row.respuestas<2)?"bg-danger":"bg-warning"):"bg-success";
        Table.addRow([
          {text: Calc.roundScore(row.score), class:""},
          {text: txt_resp, class: class_colors},
          {text: row.doc, class:""},
          {text: Calc.detalle(row), class:""}
        ],comms);
      });
    },
    clearTable(){
      $("#tbody").empty();
      Table.lastrow = 0;
    },
    addRow(row, comments){
      // row = [{text:"", class:""}...{}]
      // comments = []
      const id = Table.lastrow++;

      // Create comments html
      let comments_items = "";
      comments && comments.forEach(function(comment){
        comments_items += Table.comment_html.replace("COMMENT", comment);
      });

      // Create row html
      let row_html = "";
      row.forEach(function(elem){
        row_html += Table.row_html.replace("TEXT", elem.text || "").replace("CLASS", elem.class || "");
      });

      const raw_html = Table.html_item + (comments? Table.comment_div : "");
      const html = raw_html.replace(/ID/g, id).replace("DATA_ROW",row_html).replace("COMMENT_LIST", comments_items || "");

      $("#tbody").append(html);
    },
    html_item: '<tr data-toggle="collapse" data-target="#demoID" class="accordion-toggle zebra">\
      DATA_ROW\
    </tr>',
    comment_div:'<tr>\
        <td colspan="6" class="hiddenRow">\
            <div id="demoID" class="accordian-body collapse ml-3">\
            COMMENT_LIST\
            </div>\
        </td>\
    </tr>',
    row_html: '<td class="CLASS">TEXT</td>',
    comment_html: '<div class="col-12 zebra">COMMENT</div>'
  }

  // Selectpicker
  getJSON("data/comun.json", function(data,st){
    console.log("cursos loaded!");
    let html="";
    data.materias.forEach(function(x,i){
      html += '<option class="option" value="' + x.codigo + '">' + x.codigo + " " + x.nombre + '</option>'
    });
    $("#materia").empty().append(html).selectpicker('val','').removeAttr("disabled").selectpicker('refresh'); //important!

    $("#materia").val($(document).getUrlParam("mat")).selectpicker('refresh');

    $("#materia").on('changed.bs.select',function(e){
      const url = $(location).attr('href').split("?")[0] + "?mat="+$("#materia").val();
      $(location).attr('href', url);
    })
  }).fail(function(e){
    console.log("Error loading cursos");
  });
</script>

</body>
</html>
